# Changelog

## [2024-07-31] - 返回按鈕功能優化

### 修改
- 更新通用返回按鈕組件 (`frontend/components/back-button.tsx`)
  - 將返回行為從 `router.back()` 改為 `router.push('/')`
  - 確保「回大戶投」按鈕始終導航回首頁（overview-page）
  - 提供更一致的用戶體驗，避免返回到預期之外的頁面

## [2024-07-31] - 優化返回按鈕統一風格

### 修改
- 創建通用返回按鈕組件 (`frontend/components/back-button.tsx`)
  - 實現一致的「回大戶投」返回按鈕風格和功能
  - 替代原來各個頁面不一致的箭頭圖標返回按鈕
- 更新所有頁面的返回按鈕：
  - 社群頁面 (`frontend/app/feng-community/page.tsx`)
  - 社群首頁 (`frontend/app/feng-community/home/page.tsx`)
  - 類股看板頁面 (`frontend/app/feng-community/stock-board/page.tsx`)
  - 豐神榜頁面 (`frontend/app/feng-community/leaderboard/page.tsx`)
  - 智慧小豐頁面 (`frontend/app/smart-feng/page.tsx`)
- 統一所有返回功能使用 router.back() 實現

## [2024-07-31] - 社群頁面導航元件重構和新頁面創建

### 新增
- 新增社群專用導航元件 (`frontend/components/community-navigation.tsx`)：
  - 創建通用導航組件，包含「豐社群」、「豐神榜」、「類股看板」三個頁面標籤
  - 實現頁面間的導航功能，自動高亮當前頁面標籤
- 新增類股看板頁面 (`frontend/app/feng-community/stock-board/page.tsx`)：
  - 創建類似Dcard風格的討論版分類頁面
  - 實現科技類、金融類、消費類、醫療生技、製造業等主要分類
  - 每個分類下包含多個子版塊，可查看對應的討論主題
- 新增豐神榜頁面 (`frontend/app/feng-community/leaderboard/page.tsx`)：
  - 展示投資績效排名靠前的用戶列表
  - 提供按投資類型和時間範圍篩選的功能
  - 使用視覺化標記突出前三名用戶

### 修改
- 社群頁面 (`frontend/app/feng-community/page.tsx`):
  - 移除底部導航欄（首頁、我的關注、我的投資、投資市場、錢包）
  - 整合新的通用導航元件
- 社群首頁 (`frontend/app/feng-community/home/page.tsx`):
  - 移除底部導航欄
  - 整合新的通用導航元件
  - 調整浮動按鈕位置，適應新的頁面布局

## [2024-07-31] - 社群頁面導航優化與風格統一

### 修改
- 社群頁面 (`frontend/app/feng-community/page.tsx`):
  - 移除上方導航標籤區域（指數、大宗商品、貨幣、指數股票型基金、跟投交易員）
  - 根據overview-page風格優化整體頁面配色：
    - 將白色背景卡片改為深色背景卡片 (#111419)，並添加灰色邊框
    - 將綠色上漲標記改為紅色上漲標記，符合台灣市場習慣
    - 優化星星圖標顏色為金色 (#daa360)
    - 將分類標籤選中狀態改為金色 (#daa360)
    - 統一各區塊間的分隔線樣式，使用 border-b-8 border-black
  - 整體風格與 overview-page 保持一致，更符合產品設計

## [2024-07-31] - 社群主頁本地化完成

### 修改
- 社群主頁 (`frontend/app/feng-community/page.tsx`):
  - 將所有英文名稱改為中文名稱 (如 Zheng Bin 改為 鄭彬，Thomas Parry Jones 改為 陳志明)
  - 將 "CopyTrader" 翻譯為「跟投交易員」
  - 將英文介紹內容翻譯為中文 (如 "Multi-asset Investing. Here to make your investing life EASIER" 改為「多元資產投資。致力於讓您的投資生活更輕鬆」)
  - 更新照片連結，使用用戶提供的網絡圖片
  - 保持了整體介面的一致性和本地化風格

## [2024-07-31] - 增強社群頁面本土化內容

### 新增
- 社群首頁 (`frontend/app/feng-community/home/page.tsx`):
  - 新增「鋼鐵人」角色和相關投資內容，增強頁面多樣性
  - 添加更多台灣市場相關標籤，如 #半導體、#台積電、#長期投資、#金融股、#定期定額、#存股
  - 豐富股票資訊卡片，增加新的股票代碼和行情數據
  - 優化股票數據顯示，使用紅色表示上漲、綠色表示下跌，符合台灣市場習慣

### 修改
- 社群首頁 (`frontend/app/feng-community/home/page.tsx`):
  - 完善現有角色帖子的內容編排與視覺效果
  - 增強海綿寶寶帖子的投資相關標籤，使內容更加豐富

## [2024-07-30] - 投資筆記功能與智慧小豐整合優化

### 新增
- 整合筆記功能到智慧小豐對話界面：
  - 用單一筆記引用圖標替換了原有的麥克風、圖片和附件三個圖標
  - 實現筆記選擇器界面，可以瀏覽和選擇已保存的筆記
  - 點擊筆記後自動生成格式化的引用文本插入到對話框
  - 支持未保存筆記時直接跳轉到筆記創建頁面
  - 引用文本包含筆記標題、內容摘要、標籤和來源信息
- 新增投資筆記功能：
  - 創建新的筆記頁面 (`/notes`)，支持添加、編輯、刪除和搜索筆記
  - 從新聞詳情頁的「存筆記」按鈕可直接將新聞內容保存為筆記
  - 使用 localStorage 存儲筆記數據，支持標籤和來源管理
  - 在總覽頁將「股票抽籤」圖標替換為「投資筆記」圖標，提供快速訪問
  - 完善筆記編輯界面，支持添加標籤、查看來源和日期

### 改進
- 改進了新聞詳情頁與智慧小豐頁面之間的交互方式：
  - 將原來通過URL傳遞完整新聞內容的方式改為只傳遞新聞ID
  - 在智慧小豐頁面通過動態導入獲取預定義的新聞數據
  - 這種方式更加簡潔高效，避免了URL編碼/解碼錯誤和URL過長問題
  - 改進了錯誤處理方式，提高了應用穩定性
  - 兼容舊的URL參數形式，確保系統平滑過渡

### 最佳實踐
- 使用 localStorage 進行筆記資料管理，實現無需後端的數據持久化
- 添加完整的錯誤處理機制，提高應用穩定性
- 實現統一的筆記格式化模板，確保引用內容結構一致和可讀性
- 拆分重用代碼邏輯，提高代碼質量和維護性

### 修復
- 智慧小豐頁面 (`smart-feng/page.tsx`):
  - 修復URL參數解析錯誤，增強 `decodeURIComponent` 的錯誤處理
  - 添加JSON解析的額外錯誤處理，防止無效數據導致應用崩潰
  - 實現必要字段驗證，確保解析後的新聞內容包含所需信息
- 新聞詳情頁面 (`news-detail-page.tsx`):
  - 改進新聞內容的編碼方式，處理章節內容中可能的空值
  - 添加URL參數長度檢查，過長時自動縮短內容避免URL超長錯誤
  - 實現錯誤處理機制，在編碼失敗時傳遞簡化版本的內容

## [2024-07-30] - 按鈕樣式優化與投資筆記功能

### 優化
- 新聞詳情頁面 (`news-detail-page.tsx`):
  - 將「問小豐」和「存筆記」按鈕改為圖標+文字的組合式按鈕
  - 添加醒目的背景色（金色和紅色）提高可見度
  - 調整按鈕內邊距與圓角，優化視覺效果
  - 添加懸停交互效果
  - 結合圖標與文字，兼顧直觀性與可讀性

## [2024-07-30]

### 新增
- 新聞詳情頁面 (`news-detail-page.tsx`): 
  - 在分享圖標旁邊添加了「問小豐」和「存筆記」兩個按鈕
  - 實現「問小豐」功能，將新聞內容傳遞到智慧小豐頁面作為附件
  - 「存筆記」按鈕暫時顯示一個提示，將來可以實現完整的筆記功能
- 智慧小豐頁面 (`smart-feng/page.tsx`): 
  - 添加接收新聞內容的功能，通過URL參數解析並顯示為附件
  - 新增新聞附件顯示區，包含標題、分類、日期和內容預覽
  - 實現將新聞內容作為上下文添加到用戶問題中，幫助AI更准確地回答相關問題
  - 預填充輸入框，引導用戶向新聞內容提問

### 改進
- 改進使用者體驗，當用戶從新聞詳情頁點擊「問小豐」時，自動填入相關提示文本
- 優化用戶輸入流程，傳遞完整的新聞內容作為上下文，提高AI回答的準確性和相關性

### 最新更新
- 整合筆記功能到智慧小豐對話界面：
  - 用單一筆記引用圖標替換了原有的麥克風、圖片和附件三個圖標
  - 實現筆記選擇器界面，可以瀏覽和選擇已保存的筆記
  - 點擊筆記後自動生成格式化的引用文本插入到對話框
  - 支持未保存筆記時直接跳轉到筆記創建頁面
  - 引用文本包含筆記標題、內容摘要、標籤和來源信息
- 新增投資筆記功能：
  - 創建新的筆記頁面 (`/notes`)，支持添加、編輯、刪除和搜索筆記
  - 從新聞詳情頁的「存筆記」按鈕可直接將新聞內容保存為筆記
  - 使用 localStorage 存儲筆記數據，支持標籤和來源管理
  - 在總覽頁將「股票抽籤」圖標替換為「投資筆記」圖標，提供快速訪問
  - 完善筆記編輯界面，支持添加標籤、查看來源和日期
- 改進了新聞詳情頁與智慧小豐頁面之間的交互方式：
  - 將原來通過URL傳遞完整新聞內容的方式改為只傳遞新聞ID
  - 在智慧小豐頁面通過動態導入獲取預定義的新聞數據
  - 這種方式更加簡潔高效，避免了URL編碼/解碼錯誤和URL過長問題
  - 改進了錯誤處理方式，提高了應用穩定性
  - 兼容舊的URL參數形式，確保系統平滑過渡

### 修復
- 智慧小豐頁面 (`smart-feng/page.tsx`):
  - 修復URL參數解析錯誤，增強 `decodeURIComponent` 的錯誤處理
  - 添加JSON解析的額外錯誤處理，防止無效數據導致應用崩潰
  - 實現必要字段驗證，確保解析後的新聞內容包含所需信息
- 新聞詳情頁面 (`news-detail-page.tsx`):
  - 改進新聞內容的編碼方式，處理章節內容中可能的空值
  - 添加URL參數長度檢查，過長時自動縮短內容避免URL超長錯誤
  - 實現錯誤處理機制，在編碼失敗時傳遞簡化版本的內容

## [未發佈]

### 修復
- 為 `BottomNavigation` 元件添加 `z-index` (z-40)，嘗試解決其在 `OverviewPage` 上可能因堆疊順序問題導致背景看起來透明的問題。

### 新增
- 專案初始化，建立 `開發計畫.md` 與 `changelog.md`。
- **LLM 接入 - 智慧小豐後端基礎建設**:
  - 建立 `backend/app/services/llm_interface.py` 並加入佔位函式。
  - 建立 `backend/app/services/rag_service.py` 並加入佔位函式。
  - 建立 `backend/app/api/endpoints/assistant.py` 並加入基礎 API 端點結構。
  - 建立 `backend/app/api/__init__.py` 與 `backend/app/api/endpoints/__init__.py` 使 FastAPI 能識別。
  - 建立 `backend/data/` 目錄及 `.gitkeep` 檔案，用於存放 RAG 文件。
- **LLM 接口實現 (Google Gemini)**:
  - 修改 `backend/app/services/llm_interface.py` 以整合 Google Gemini API (`gemini-pro` 模型)。
  - 實作從環境變數 (`GOOGLE_API_KEY`) 或 `.env` 檔案讀取 API 金鑰。
  - 使用 FastAPI 的 `run_in_threadpool` 處理同步的 SDK 呼叫，避免阻塞事件循環。
- 於「總覽」頁面 (`overview-page.tsx`) 的「豐雲學堂」及「新聞7×24」頁籤中，為除了第一個新聞項目以外的其他新聞項目，也加上點擊後導向新聞詳情頁面的功能。
- 修改 `news-detail-page.tsx` 以接收新聞資料作為 prop，並動態顯示內容。
- 修改 `overview-page.tsx` 以管理所選新聞項目的資料，並將其傳遞給 `news-detail-page.tsx`，實現點擊不同新聞顯示不同內容的功能。
- 新增 `frontend/components/news-detail-page.tsx` 元件以顯示新聞詳情。
- 將使用者提供的特定新聞內容填入 `overview-page.tsx` 的第一個佔位新聞項目中。

## [2025-05-10] - 優化市場指數頭部組件API請求效能

### 修復
- 前端 (`components/market-indices-header.tsx`): 
  - 優化市場指數頭部組件，解決多次重複API請求問題。
  - 添加防抖（debounce）機制，減少不必要的請求頻率。
  - 使用 `useRef` 追蹤請求狀態，避免重複請求。
  - 使用 `useCallback` 避免函數重複創建。
  - 啟用定時刷新功能，但延長刷新間隔至60秒以減輕服務器負載。
  - 使用 `React.memo` 包裝組件減少不必要的重新渲染。
  - 優化控制台日誌，只在開發環境顯示。

### 技術說明
- 透過防抖機制和 `useRef` 追蹤，解決了組件重複渲染導致的頻繁API請求問題。
- 添加了請求狀態追蹤，確保API請求不會在上一次請求完成前重複發起。
- 透過延長定時刷新間隔（從未啟用到60秒刷新一次），平衡數據即時性和伺服器負載。
- 使用 `React.memo` 減少因父組件更新導致的不必要重新渲染。

## [Unreleased] - YYYY-MM-DD

### Added
- Initial frontend directory structure created (`src/components`, `src/pages`, `src/services`, `src/hooks`, `src/styles`, `src/assets`, `src/utils`).
- 添加項目預覽指南，需先執行 `npm install` 後再啟動開發伺服器 
- 後端 API：新增 `/api/v1/market/{stock_id}/historical` 端點，用於獲取台股歷史股價數據 (日線)，使用 `yfinance` 作為數據源。
  - 支援依 `period` (如 1y, 3mo) 或 `start_date` 與 `end_date` 查詢。
  - 整合 Pydantic 模型進行請求驗證與回應格式化。
  - 依照專案規範，路由置於 `backend/app/endpoints/market_data.py`，服務邏輯置於 `backend/app/services/stock_service.py`。
  - 採用 `async/await` 及 `run_in_threadpool` 處理 I/O 密集型操作。
- **apiClient.ts**: 添加熱門股票API介面（`HotStockInfo`）和獲取熱門股票數據的函數（`getHotStocks`），以支持選股頁面顯示真實股票數據。
- **stock-selection-page.tsx**: 更新選股頁面使用真實股票數據，包含：
  - 動態顯示市場指數數據（加權指數、櫃買指數）
  - 動態顯示熱門股票資訊
  - 添加載入狀態和錯誤處理
  - 實現熱門股票類型切換功能（成交值、瞬間量、即將漲停、即將跌停）

### Fixed
- 修復 date-fns 與 react-day-picker 依賴衝突問題，使用 `npm install --legacy-peer-deps` 安裝 
- 改進市場指數頭部組件佈局，調整為垂直對齊結構，使各指數和數值在同一直線上
- 修復 React 水合不匹配錯誤，於 next.config.mjs 中添加配置以處理瀏覽器擴充功能干擾
- 全面解決頑固的 React 水合錯誤：添加 MutationObserver 腳本移除擴充功能屬性，並在關鍵元素上使用 suppressHydrationWarning
- 重新設計市場指數頭部組件佈局，從垂直堆疊改為水平排列，將指數標題和數值顯示在同一行
- 優化市場指數頭部組件的手機版顯示，保持字體大小，通過減少邊距與間距確保在小螢幕上仍維持單行顯示
- 優化交易資訊網格的尺寸與樣式，減小文字和間距以符合界面設計要求，使其更緊湊易讀
- 更新總覽頁面交易資訊格線內容與排版，符合新的顯示需求。
- 進一步細化總覽頁面交易資訊格線內部佈局，以符合更詳細的設計要求。
- 調整總覽頁面左上角交易資訊格點佈局，將「今日委託」與「今日成交」並列顯示於同一行。
- 更新總覽頁「精彩節目」區塊：改為兩欄式佈局，左側為自動輪播內容區塊，右側為靜態圖片。
- **UI**: 統一多個頁面 (`overseas-page.tsx`, `funds-page.tsx`, `stock-selection-page.tsx`, `favorites-page.tsx`, `account-page.tsx`) 主要區塊間的分隔線樣式，採用 `border-b-8 border-black`。
- **account-page.tsx**: 根據截圖大幅修改帳務頁面樣式，調整包含總資產顯示、帳戶資訊排版、市值與損益呈現方式、圖示及邊框樣式。
- **account-page.tsx**: 進一步細化帳務頁面樣式，使其更貼近截圖，調整內容包含整體頁面背景色、各區塊背景色層次、按鈕顏色及標籤顏色。
- **account-page.tsx**: 移除「豐存股-美股」卡片標題列與其內容區塊間的細分隔線，使兩者在視覺上合併為單一卡片。
- **stock-selection-page.tsx**: 修復指數卡片顯示N/A的問題，將指數ID從`tse_t00.tw`、`otc_o00.tw`修改為與API返回格式匹配的`t00.tw`、`o00.tw`。
- **stock-selection-page.tsx**: 改進指數卡片顯示，根據漲跌狀態變更背景顏色（上漲為紅色背景，下跌為綠色背景）。
- **apiClient.ts**: 增強熱門股票數據獲取功能，為不同類型（成交值、瞬間量、即將漲停、即將跌停）提供適當的數據，對「成交值」類型使用真實股票數據。
- **stock-selection-page.tsx**: 當「即將漲停」和「即將跌停」類別沒有數據時顯示相應提示訊息，改善用戶體驗。
- **stock-selection-page.tsx**: 優化股票數據顯示區域的對齊方式，通過設定寬度佔比及使用flex布局，使價格、漲跌幅和成交量數據對齊中間靠右，提高數據可讀性。
- **stock-selection-page.tsx**: 美化股票類型選項標籤，將未選中標籤顏色從灰色改為白色，並為選中標籤添加粗體樣式，提高視覺對比度和用戶體驗。

### Changed
- **智慧小豐功能調整**: 暫停 RAG (Retrieval Augmented Generation) 功能的開發，改為讓「智慧小豐」直接與 LLM 互動處理純文本輸入。

## YYYY-MM-DD - Gemini API 整合 (智慧小豐)

- **新增**: 整合 Gemini API 到智慧小豐聊天功能。
- **修改**: 後端 (`backend/app/api/endpoints/assistant.py`)
    - 移除 RAG 服務呼叫。
    - `query_assistant` 端點現在直接呼叫 Gemini API (`gemini-pro` 模型) 以生成回應。
    - 從環境變數 `GEMINI_API_KEY` 讀取 API 金鑰。
- **修改**: 後端 (`backend/requirements.txt`)
    - 新增 `google-generativeai` 依賴。
- **修改**: 前端 (`frontend/app/smart-feng/page.tsx`)
    - `handleSend` 和 `handleFlashcardClick` 函數現在會呼叫後端 `/api/assistant/query` 端點。
    - 移除模擬 AI 回應的邏輯。
    - 新增 "思考中..." 的使用者提示。
    - 改善錯誤處理，向使用者顯示 API 錯誤訊息。
    - 更新 `Message` interface 以支援 `isTyping` 狀態。

## YYYY-MM-DD - API 路由與代理修正

- **修改**: 後端 (`backend/app/main.py`)
    - 為 `market_data.router` 和 `assistant.router` 統一加上 `/api` URL 前綴。
    - 正確匯入並註冊 `assistant.router`。
- **修改**: 前端 (`frontend/next.config.mjs`)
    - 新增 `rewrites` 規則，將前端 `/api/:path*` 的請求代理到後端 FastAPI 服務 (`http://localhost:8000/api/:path*`)。
    - 此修改旨在解決前端呼叫後端 API 時出現的 404 錯誤。

## YYYY-MM-DD - 環境變數管理更新

- **修改**: 後端 (`backend/requirements.txt`)
    - 新增 `python-dotenv` 依賴，用於從 `.env` 檔案載入環境變數。
- **修改**: 後端 (`backend/app/main.py`)
    - 在應用程式啟動時使用 `python-dotenv` 的 `load_dotenv()` 函數從 `backend/.env` 檔案載入環境變數。
    - 這確保 `GEMINI_API_KEY` 可以被 `os.getenv()` 正確讀取。

## YYYY-MM-DD - 新增系統指令支援

- **修改**: 後端 (`backend/app/api/endpoints/assistant.py`)
    - 在 `query_assistant` 函數中加入了系統指令 (System Instruction) 的設計。
    - 系統指令會與使用者的問題結合，然後一起傳送給 Gemini 模型。
    - 改用 `ChatSession` (`model.start_chat()` 和 `chat.send_message_async()`) 來處理請求，為未來更完善的對話管理做準備。
    - 提供了一個預設的系統指令範例，使用者可以根據需求自行修改。

## YYYY-MM-DD - 改進對話歷史與系統指令處理

- **重構**: 後端 (`backend/app/api/endpoints/assistant.py`)
    - **系統指令**: 改為在 `GenerativeModel` 初始化時通過 `system_instruction` 參數設定，確保其在整個對話中持續有效。
    - **對話歷史**: 
        - 使用全域字典 `conversation_histories` 模擬持久化儲存，以 `user_id` 區分不同使用者的對話。
        - `ChatSession` (`model.start_chat()`) 現在會使用從 `conversation_histories` 檢索到的歷史記錄進行初始化。
        - 每次對話後，更新的 `chat.history` 會被存回 `conversation_histories`。
        - `QuestionRequest` Pydantic 模型新增 `user_id` 欄位，需由前端提供。
    - **API 呼叫**: `chat.send_message_async()` 現在只傳送使用者當前的問題，不再手動拼接系統指令。
    - 修正了 `SYSTEM_INSTRUCTION_TEXT` 多行字串定義可能導致的 linter 錯誤。

## YYYY-MM-DD - 前端整合 user_id 以支援多輪對話

- **修改**: 前端 (`frontend/app/smart-feng/page.tsx`)
    - **`user_id` 管理**: 
        - 新增 `userId` React state。
        - 使用 `useEffect` 在組件首次載入時，從 `localStorage` 讀取 `smartFengUserId`，若不存在則使用 `crypto.randomUUID()` 生成新的 ID 並存儲。
    - **API 請求**: 
        - 在 `handleSend` 和 `handleFlashcardClick` 函數中，向後端 `/api/assistant/query` 發送請求時，於 JSON body 中加入 `user_id`。
        - 此修改旨在解決因缺少 `user_id` 而導致的後端 422 (Unprocessable Entity) 錯誤。
    - **錯誤處理**: 略微改進了 API 錯誤訊息的解析與顯示。

## [YYYY-MM-DD] - 請填寫今天日期

### 新增
- 後端 (`assistant.py`): 更新 Gemini 模型的系統指令，要求使用 Markdown 格式輸出。
- 後端 (`assistant.py`): 確認並修正 Gemini 模型名稱為 `models/gemini-1.5-flash-preview-0514`，與交接文件一致。
- 文件 (`開發計畫.md`): 新增「支援 Markdown 格式輸出」及「前端 Markdown 渲染」任務。

### 調整與建議
- 前端 (`smart-feng/page.tsx`): 建議引入 `react-markdown` 套件以渲染 AI 回應中的 Markdown 內容。

## [YYYY-MM-DD] - 請填寫今天日期

### 修復
- 後端 (`assistant.py`): 將 Gemini 模型名稱從 `models/gemini-1.5-flash-preview-0514` 更正為 `models/gemini-1.5-flash-preview-0514` (先前誤植)。

### npm 相關
- 前端 (`frontend`): 針對安裝 `react-markdown` 時出現的 `ERESOLVE` 錯誤 (因 `react-day-picker` 與 `date-fns` 版本衝突)，建議嘗試使用 `npm install react-markdown --legacy-peer-deps` 指令安裝。

## [YYYY-MM-DD] - 請填寫今天日期

### 調整
- 後端 (`assistant.py`): Gemini 模型名稱由使用者手動更新為 `models/gemini-1.5-flash-preview-0514`。

## [2025-05-09] - 實現 Markdown 格式渲染功能

### 新增
- 前端 (`frontend`): 安裝 `react-markdown` 與 `remark-gfm` 套件，用於渲染 Markdown 格式文本。
- 前端 (`smart-feng/page.tsx`): 
  - 添加 Markdown 渲染功能，使智慧小豐輸出的粗體、清單等格式化文本能夠正確顯示。
  - 自定義 Markdown 組件的渲染樣式，如粗體文字顯示為金色、標題樣式、清單項的縮進等。
- 前端 (`globals.css`): 
  - 添加 Markdown 內容相關樣式，包括列表、區塊引用、程式碼區塊等格式化樣式。

### 修改
- 前端 (`smart-feng/page.tsx`): 條件渲染 Markdown 內容，只在助理回答且非「思考中」狀態時使用 Markdown 渲染。

### 技術說明
- 使用 `react-markdown` 作為核心 Markdown 解析與渲染庫。
- 使用 `remark-gfm` 插件以支援 GitHub Flavored Markdown 功能，如表格、刪除線等。
- 通過 `components` 屬性自定義各 Markdown 元素的渲染樣式，使其符合應用設計風格。
- 在全局 CSS 中添加專用樣式類，確保 Markdown 內容的一致性與美觀性。

## [2025-05-09] - 新增歷史對話功能

### 新增
- 前端 (`smart-feng/page.tsx`): 
  - 在智慧小豐介面右上角添加歷史對話按鈕，使用 History 圖標。
  - 實現歷史對話側邊面板，包含對話列表、新對話按鈕和刪除功能。
  - 對話歷史按照時間排序，顯示標題、預覽和時間。
  - 實現從歷史記錄恢復對話的功能。
  - 開發「新對話」功能，可以開始全新的對話。
  - 實現對話自動保存機制，將對話保存到本地存儲。
  - 實現日期格式化，對今天和昨天的記錄使用相對時間。

### 修改
- 前端 (`smart-feng/page.tsx`): 
  - 重新組織組件布局，添加頂部欄右側功能區。
  - 調整對話交互邏輯，現在能將對話與對話ID關聯。
  - 完善頁面加載時的對話恢復機制，從 localStorage 恢復上次對話。

### 技術說明
- 使用 `localStorage` 存儲對話歷史，包括所有消息內容和時間戳。
- 使用 TypeScript 定義 `ChatHistory` 接口，包含 id、標題、預覽和消息數組。
- 添加動畫效果使側邊面板平滑滑入。
- 實現智能判斷對話狀態(新對話/繼續對話)的邏輯。
- 限制最多保存 30 個歷史對話，以避免存儲空間過大。

## [2025-05-09] - 修復歷史對話功能中的無限循環渲染問題

### 修復
- 前端 (`smart-feng/page.tsx`): 
  - 修正 `useEffect` 中的無限循環更新問題，這個問題會導致 "Maximum update depth exceeded" 錯誤。
  - 重構對話保存邏輯，使用 `useRef` 防止循環依賴。
  - 添加防抖（debounce）機制限制保存頻率，避免頻繁更新觸發循環渲染。
  - 添加深比較邏輯，避免不必要的狀態更新。

### 技術說明
- 使用 React `useRef` 鉤子保存最新狀態引用，避免 `useEffect` 依賴項導致的循環。
- 實現 1 秒防抖延遲，僅在用戶停止交互後保存對話歷史。
- 在加載歷史對話時增加狀態比較，只有當消息內容實際變化時才更新 `messages` 狀態。
- 優化狀態更新邏輯，減少不必要的渲染次數。

## [2025-05-09] - 修復多輪對話上下文記憶問題並添加重置功能

### 修復
- 後端 (`assistant.py`): 
  - 修改系統指令，添加明確要求模型記住對話歷史並理解上下文的指示。
  - 強調不要聲稱無法記憶或回溯用戶之前發送的訊息內容。
  - 添加調試日誌功能，便於追蹤對話歷史的傳遞與保存。
  - 增強對歷史記錄存在性的檢查，確保正確保存與使用對話歷史。

### 新增
- 後端 (`assistant.py`):
  - 新增 `/assistant/reset` API 端點，用於重置特定用戶的對話歷史。
- 前端 (`smart-feng/page.tsx`):
  - 添加「重置對話」功能按鈕，可清除後端對話記憶，重新開始對話。
  - 改進側邊面板按鈕布局，使用網格排列按鈕。
  - 簡化「開始新對話」按鈕的文字為「新對話」，節省空間。

### 技術說明
- 前端重置功能會先調用後端 API 清除對話歷史，然後在前端重置狀態。
- 系統指令中添加了具體指示，讓模型理解上下文和回溯之前的對話內容的重要性。
- 使用 Python 的 `getattr` 安全獲取對象屬性，避免在處理複雜對象時出現錯誤。

## [2025-05-09] - 修復「開始新對話」未完全重置對話歷史的問題

### 修復
- 前端 (`smart-feng/page.tsx`): 
  - 修改 `startNewChat` 函數，使其從同步函數變為異步函數，以便調用後端 API。
  - 在用戶點擊「新對話」按鈕時，同時調用後端的 `/assistant/reset` API 端點清除對話歷史。
  - 開始新對話時生成新的對話 ID 並保存到 localStorage，而不是移除對話 ID。

### 增強
- 後端 (`assistant.py`):
  - 在系統指令中添加關於「新對話」和「重置對話」的特別說明，提醒模型在這些情況下記憶被清空，應將其視為全新的對話開始。

### 技術說明
- 這個修改解決了前端開始新對話時，後端仍保留舊對話歷史的問題。
- 現在開始新對話的流程是：保存當前對話到歷史記錄 → 調用後端重置 API → 清空前端消息 → 生成新的對話 ID。
- 通過讓模型理解「新對話」的概念，確保用戶體驗的一致性和預期的行為。

## [2025-05-09] - 徹底重構對話歷史管理機制解決上下文記憶問題

### 修復
- 後端 (`assistant.py`): 
  - 完全重寫對話歷史管理，不再依賴Gemini API的內部記憶機制，而是自己實現完整的對話管理。
  - 創建專用的 `MemoryManager` 類來管理對話歷史，確保對話內容正確保存和傳遞。
  - 將對話歷史作為上下文直接插入到每次請求中，而不是依賴API的歷史參數。
  - 修復模型無法記住前文的問題，現在能正確回答「我上個問題問什麼」等涉及上下文的問題。

### 技術說明
- 新的實現採用了更直接和可控的方式處理對話歷史：
  - 使用自定義的數據結構來存儲和管理對話歷史
  - 採用「注入上下文」的方式，顯式地將先前對話發送給模型
  - 完全控制對話流程，不依賴第三方API的內部機制
  - 增加了更詳細的日誌，便於調試和診斷問題
- 這種實現更穩定、可靠，能更好地控制對話的持續性和上下文理解能力。

## [2025-05-10] - 改進對話歷史管理：使用Gemini API原生會話機制

### 修復
- 後端 (`assistant.py`): 
  - 捨棄之前的「上下文注入」方法，轉為正確使用Gemini API原生的會話功能。
  - 實現更簡潔、高效的對話歷史處理，不再每次都重新傳輸整個對話歷史。
  - 使用 `user_chats` 字典儲存各用戶的會話實例，確保對話連貫性。
  - 添加調試端點，方便檢查用戶對話歷史，解決問題。

### 增強
- 後端 (`assistant.py`):
  - 添加了更全面的日誌記錄，使用統一的 `debug_print` 函數。
  - 重置功能更完善，不僅刪除舊會話，還會創建新會話。
  - 提示詞優化，直接指示模型記住對話歷史和理解上下文。

### 技術說明
- 使用API原生對話功能的好處：
  - 減少每次請求的 token 消耗，優化成本
  - 簡化代碼邏輯，移除不必要的上下文處理
  - 更好地利用模型的設計功能，而非繞過它
  - 提高響應速度，減少不必要的數據傳輸
- 添加了調試端點以便在問題出現時檢查對話狀態，提高問題解決效率。

## [2025-05-10] - 修復市場數據API路由前綴配置問題

### 修復
- 後端 (`endpoints/market_data.py`): 
  - 修改路由前綴配置，從 `/api/v1/market` 調整為 `/v1/market`，解決與 `main.py` 中添加的 `/api` 前綴重複的問題。
  - 此修改解決了前端在訪問 `/api/v1/market/indices/realtime` 時出現的 404 錯誤。

### 技術說明
- 該問題是由於路由註冊時前綴重疊造成的：
  - `market_data.router` 設定了前綴 `/api/v1/market`
  - 同時在 `main.py` 中又添加了前綴 `/api`
  - 導致實際路由變成了 `/api/api/v1/market/indices/realtime`
  - 而前端請求的是 `/api/v1/market/indices/realtime`
- 透過修改路由前綴配置，確保API路徑正確，使前端能夠成功獲取市場指數數據。

## [2025-05-12] - 智慧小豐知識庫功能改進

### 新增
- 後端 (`assistant.py`): 
  - 實現了一個更直接的知識庫設計，將知識文章全部加載到系統提示中
  - 新增 `/data/knowledge_base.json` 作為知識庫文章的存儲，包含文章標題、來源、URL和內容
  - 實現自動格式化處理，使知識庫內容更具可讀性和引用性

### 改進
- 後端 (`assistant.py`):
  - 將知識庫處理從前端移至後端，減少網絡傳輸負擔
  - 調整系統提示，要求模型正確引用知識庫中的來源URL
  - 最大化利用LLM的上下文窗口能力，直接提供完整知識，無需檢索

### 移除
- 前端 (`smart-feng/page.tsx`):
  - 移除了前端的知識庫數據和檢索邏輯
  - 簡化了消息發送邏輯，直接將用戶問題發送到後端

## [2025-05-11] - 智慧小豐知識庫功能

### 新增
- 前端 (`smart-feng/page.tsx`): 
  - 添加小型知識庫功能，包含五篇投資相關知識文章。
  - 實現知識檢索系統，能根據用戶問題智能匹配相關知識文章。
  - 在回答中顯示資訊來源引用（例如：「資訊來源：豐雲學堂《股票投資基礎知識》」）。
  - 支援關鍵詞匹配、標題匹配和內容匹配三種檢索方式，並設定不同權重提高檢索準確性。

### 修改
- 前端 (`smart-feng/page.tsx`): 
  - 增強 `handleSend` 和 `handleFlashcardClick` 函數，使其在發送用戶問題前檢索知識庫。
  - 如果找到相關文章，會將文章內容作為上下文添加到問題中，並要求AI在回答中引用來源。
- 後端 (`assistant.py`): 
  - 擴展 `QuestionRequest` 類，添加 `knowledge_source` 欄位，用於記錄知識來源。

### 技術說明
- 知識庫使用前端靜態數據實現，包含五篇關於投資的文章：股票基礎知識、技術分析、投資心理學、基本面分析和風險管理。
- 檢索算法為簡單的關鍵詞匹配和文本相似度計算，為不同匹配類型分配不同權重。
- 將檢索到的文章內容與用戶問題一起發送到後端，指示AI使用這些知識回答並引用來源。

## [2025-05-12] - 智慧小豐問題前綴功能

### 新增
- 前端 (`smart-feng/page.tsx`): 
  - 在發送到後端的問題前添加"詢問:"前綴
  - 同時對用戶手動輸入的問題和從常用字卡選擇的問題都添加前綴
  - 這使模型能夠更清晰地識別用戶的問題，提高回答準確性

## 2023-09-15
- 新增智慧小豐頁面基本架構
- 實現對話輸入與回應功能
- 添加歷史記錄功能

## 2023-09-20
- 優化對話界面
- 添加常用字卡功能
- 修復已知的錯誤

## 2023-10-05
- 增加對話記憶功能
- 優化後端API連接
- 修復對話重置問題

## 2023-11-01
- 優化對話歷史管理
- 增加錯誤處理與提示
- 改進UI視覺體驗

## 2023-11-15
- 優化常用字卡顯示
- 添加Markdown格式支持
- 改進對話加載速度

## 2023-11-30
- 增強對話存儲功能
- 改進對話流暢度
- 優化使用者體驗

## 2024-06-01
- 優化常用字卡視覺效果，增加卡片尺寸與文字大小
- 新增「豐雲學堂」功能，提供分類內容：市場話題、新手知識、選股策略、平台活動、量化殿堂
- 改進按鈕佈局與互動體驗

## 2024-06-02
- 更改豐雲學堂按鈕顏色為紅色系(#c4382c)，提高視覺區分度
- 全面優化豐雲學堂卡片設計，添加分類標題背景色
- 改進項目交互效果，增加懸停反饋
- 調整間距和尺寸，使界面更美觀易用

## 2024-06-03
- 豐雲學堂風格調整：根據用戶提供圖片，將背景改為淺米色，文字改為深色，分類標題改為淺色圓角標籤樣式
- 移除豐雲學堂卡片邊框和陰影，使其更符合圖片風格
- 調整導航按鈕和分頁點顏色以適應新的淺色主題
- 移除分類標題前的數字編號

## 2024-06-04
- 豐雲學堂佈局調整：將「豐雲學堂」區塊恢復為類似「常用字卡」的卡片式佈局。
- 顏色風格保持淺色主題：卡片背景為白色，搭配淺色邊框和陰影。
- 文字和交互顏色：分類標題使用琥珀色，項目文字為深灰色，滑鼠懸停時項目文字變為深琥珀色並帶有淺背景色。
- 標題更新：「豐雲學堂」區塊主標題更新為「豐雲學堂最新資訊」。
- 分頁點主色調更新為琥珀色。

## 2024-06-05
- 豐雲學堂細節優化：卡片內項目字體大小調整為與「常用字卡」一致 (text-base)。
- 項目間分隔線顏色更新為與「豐雲學堂」按鈕顏色一致 (#c4382c)。

## 2024-06-06
- 豐雲學堂卡片風格調整：卡片背景改為深灰色(bg-gray-900)，以匹配「常用字卡」的卡片外觀。
- 卡片內文字顏色調整：分類標題使用紅色(#c4382c)，字體大小xl，字重medium；項目文字為白色，滑鼠懸停時變為紅色(#c4382c)。
- 分隔線顏色：卡片內所有分隔線（標題下方及項目間）恢復為深灰色(border-gray-800)，以適應深色卡片背景。
- 分頁點活動顏色：配合卡片內紅色主題，將活動狀態的分頁點顏色改為紅色(#c4382c)。

## 2024-07-29

- 更新「豐雲學堂」區塊樣式，使其背景及相關元素配色與「常用字卡」區塊的深色主題一致。
- 調整「豐雲學堂」區塊：主標題靠左對齊，內部卡片背景改為rgb(244,232,218)，並同步調整卡片內文字與分隔線顏色以適應淺色背景。
- 調整「豐雲學堂」卡片內分類標題樣式：靠左對齊、粗體、文字顏色設為#c4382c。

- 分析 `assistant.py` 如何將知識庫內容（包含 `title`, `source`, `url`, `content`）提供給語言模型。
- 修改 `assistant.py`，在提供給語言模型的知識庫文章內容中加入 `keywords`。
- 修改 `assistant.py`，在提供給語言模型的知識庫文章內容中加入 `id`，確保所有欄位都被納入。
- 優化 `assistant.py` 中的系統提示詞 (`SYSTEM_INSTRUCTION_TEXT`)，強化知識庫引用和連結提供，並針對「豐雲學堂」相關問題指導模型推薦多篇文章。

## [YYYY-MM-DD] - 版本號或日期

### 新增
- 於「總覽」頁面中的「豐雲學堂」及「新聞7×24」分頁，為第一則新聞項目新增點擊功能，點擊後可跳轉至一個內容寫死的新聞詳情頁面。

### 修復
- 智慧小豐頁面 (`smart-feng/page.tsx`):
  - 修復URL參數解析錯誤，增強 `decodeURIComponent` 的錯誤處理
  - 添加JSON解析的額外錯誤處理，防止無效數據導致應用崩潰
  - 實現必要字段驗證，確保解析後的新聞內容包含所需信息
- 新聞詳情頁面 (`news-detail-page.tsx`):
  - 改進新聞內容的編碼方式，處理章節內容中可能的空值
  - 添加URL參數長度檢查，過長時自動縮短內容避免URL超長錯誤
  - 實現錯誤處理機制，在編碼失敗時傳遞簡化版本的內容

## [2024-07-30] - 修復新聞數據識別問題與按鈕樣式優化

### 修復
- 修復新聞數據識別問題：
  - 智慧小豐頁面 (`smart-feng/page.tsx`)：合併 `placeholderAcademyNews` 和 `placeholderNews7x24` 數組，確保可以從兩個新聞源中查找新聞
  - 投資筆記頁面 (`notes/page.tsx`)：同樣修改為合併兩個新聞數組進行查找，提升新聞數據兼容性
  - 這些修改解決了傳遞 `7x24` 類型新聞時無法正確識別的問題

### 優化
- 新聞詳情頁面 (`news-detail-page.tsx`):
  - 將「問小豐」和「存筆記」按鈕改為圖標+文字的組合式按鈕
  - 添加醒目的背景色（金色和紅色）提高可見度
  - 調整按鈕內邊距與圓角，優化視覺效果
  - 添加懸停交互效果
  - 結合圖標與文字，兼顧直觀性與可讀性